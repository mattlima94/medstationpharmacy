<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Medstation Pharmacy Catalog</title>
<!--
╔══════════════════════════════════════════════════════════════════╗
║  MEDSTATION PHARMACY CATALOG — CONFIGURATION                    ║
║                                                                  ║
║  SETUP INSTRUCTIONS:                                             ║
║  1. Upload Medstation_Catalog_Template.xlsx to Google Sheets     ║
║  2. Go to File → Share → Publish to Web                         ║
║  3. For each tab, select the tab name and "CSV" format           ║
║  4. Copy each URL and paste below in the matching SHEET_URL      ║
║  5. Push this file to your GitHub repo                           ║
║  6. Enable GitHub Pages in repo Settings → Pages                 ║
║                                                                  ║
║  The app will auto-fetch fresh data each time someone opens it.  ║
╚══════════════════════════════════════════════════════════════════╝
-->
<script>
// ═══════════════════════════════════════════════════════
// PASTE YOUR PUBLISHED GOOGLE SHEETS CSV URLS BELOW
// (Replace each placeholder with the real URL)
// ═══════════════════════════════════════════════════════
const SHEET_URLS = {
  glp1:       'YOUR_CSV_URL_FOR_GLP1_TAB',
  peptides:   'YOUR_CSV_URL_FOR_PEPTIDES_TAB',
  testhrt:    'YOUR_CSV_URL_FOR_TESTOSTERONE_HRT_TAB',
  other:      'YOUR_CSV_URL_FOR_OTHER_PRODUCTS_TAB',
  states:     'YOUR_CSV_URL_FOR_STATE_COVERAGE_TAB',
  directory:  'YOUR_CSV_URL_FOR_PHARMACY_DIRECTORY_TAB',
};

// Shipping costs per pharmacy (update when confirmed)
const SHIPPING = {
  'RXCS': 25, 'Absolute': 20, 'Epiq': 20, 'Rush': 20,
  'Hallandale': 33, 'Texas Star': 0, 'Brooksville': 23, 'Olympia': 25,
};
const SHIPPING_ESTIMATED = { 'Absolute': true, 'Epiq': true, 'Rush': true };
// ═══════════════════════════════════════════════════════
// END CONFIGURATION — DO NOT EDIT BELOW THIS LINE
// ═══════════════════════════════════════════════════════
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0a0e17; --surface: rgba(15,22,41,0.6); --surface-hover: rgba(15,22,41,0.85);
  --border: rgba(51,65,85,0.3); --accent: #6366f1; --accent-light: #a5b4fc; --accent-bg: rgba(99,102,241,0.15);
  --text: #e2e8f0; --text-muted: #94a3b8; --text-dim: #64748b;
  --green: #10b981; --green-text: #6ee7b7; --green-bg: rgba(16,185,129,0.06); --green-border: rgba(16,185,129,0.3);
  --yellow: #fbbf24; --yellow-text: #fbbf24; --red: #ef4444; --red-text: #fca5a5;
  --font: 'DM Sans', 'Segoe UI', system-ui, sans-serif;
  --mono: 'JetBrains Mono', 'Fira Code', monospace;
}
body { background: var(--bg); color: var(--text); font-family: var(--font); min-height: 100vh; }
input, select, button { font-family: inherit; }
.header {
  background: linear-gradient(135deg, #0f1629 0%, #1a1f3a 50%, #0d1321 100%);
  border-bottom: 1px solid rgba(99,102,241,0.2); padding: 20px 24px;
}
.header-inner { max-width: 1400px; margin: 0 auto; }
.header-top { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
.logo { display: flex; align-items: center; gap: 12px; }
.logo-icon {
  width: 40px; height: 40px; border-radius: 10px;
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 700; color: white;
}
.logo h1 { font-size: 20px; font-weight: 700; letter-spacing: -0.02em; }
.logo p { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.toggle-group {
  display: flex; border-radius: 8px; background: rgba(30,41,59,0.8);
  border: 1px solid rgba(99,102,241,0.2); overflow: hidden;
}
.toggle-btn {
  padding: 8px 16px; border: none; cursor: pointer; font-size: 13px;
  font-weight: 600; background: transparent; color: var(--text-dim); transition: all 0.2s;
}
.toggle-btn.active { background: rgba(99,102,241,0.3); color: var(--accent-light); }
.tabs { display: flex; gap: 4px; margin-top: 16px; }
.tab-btn {
  padding: 8px 16px; border: none; border-radius: 8px 8px 0 0; cursor: pointer;
  font-size: 13px; font-weight: 600; background: transparent; color: var(--text-dim);
  border-bottom: 2px solid transparent; transition: all 0.2s;
}
.tab-btn.active { background: var(--accent-bg); color: var(--accent-light); border-bottom-color: var(--accent); }
.content { max-width: 1400px; margin: 0 auto; padding: 20px 24px; }
.filters { display: grid; grid-template-columns: 1fr 200px 180px 160px; gap: 12px; margin-bottom: 20px; }
@media (max-width: 900px) { .filters { grid-template-columns: 1fr 1fr; } }
@media (max-width: 600px) { .filters { grid-template-columns: 1fr; } }
.filter-input, .filter-select {
  padding: 10px 14px; border-radius: 8px; border: 1px solid rgba(99,102,241,0.2);
  background: rgba(15,22,41,0.8); color: var(--text); font-size: 14px; outline: none; width: 100%;
}
.filter-select { cursor: pointer; }
.controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 8px; }
.controls-left { display: flex; gap: 12px; align-items: center; }
.control-label { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-muted); cursor: pointer; }
.control-label input { accent-color: var(--accent); }
.result-count { font-size: 13px; color: var(--text-muted); }
.sort-select {
  padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(99,102,241,0.2);
  background: rgba(15,22,41,0.8); color: var(--text-muted); font-size: 12px; cursor: pointer;
}
/* Product rows */
.product-row {
  background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
  padding: 12px 16px; margin-bottom: 6px; cursor: pointer; transition: all 0.15s;
}
.product-row:hover { background: var(--surface-hover); }
.product-row.best { background: var(--green-bg); border-color: var(--green-border); }
.product-row.in-compare { border-color: rgba(99,102,241,0.4); }
.row-main { display: flex; align-items: center; gap: 12px; }
.badge-best {
  background: rgba(16,185,129,0.2); color: var(--green-text); padding: 2px 8px;
  border-radius: 4px; font-size: 10px; font-weight: 700; letter-spacing: 0.05em; flex-shrink: 0;
}
.pharm-pill {
  padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;
  flex-shrink: 0; min-width: 75px; text-align: center;
}
.product-name { font-size: 14px; font-weight: 500; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.product-meta { font-size: 11px; color: var(--text-dim); flex-shrink: 0; min-width: 90px; text-align: center; }
.state-badge {
  font-size: 10px; flex-shrink: 0; padding: 2px 6px; border-radius: 4px;
}
.state-badge.yes { background: rgba(16,185,129,0.15); color: var(--green-text); }
.state-badge.no { background: rgba(239,68,68,0.15); color: var(--red-text); }
.state-badge.unknown { background: rgba(251,191,36,0.15); color: var(--yellow-text); }
.price-area { text-align: right; flex-shrink: 0; min-width: 80px; }
.price-main { font-size: 16px; font-weight: 700; font-family: var(--mono); }
.price-main.best-price { color: var(--green-text); }
.price-detail { font-size: 10px; color: var(--text-dim); }
.price-est { color: var(--yellow); }
.margin-area { text-align: right; flex-shrink: 0; min-width: 60px; }
.margin-val { font-size: 12px; font-weight: 600; font-family: var(--mono); }
.margin-val.high { color: var(--green-text); }
.margin-val.mid { color: var(--yellow); }
.margin-val.low { color: var(--red-text); }
.margin-cost { font-size: 10px; color: var(--text-dim); }
/* Expanded details */
.product-details {
  margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);
  display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; font-size: 13px;
}
.detail-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
.detail-value { margin-bottom: 8px; }
/* Compare cards */
.compare-empty { text-align: center; padding: 60px; color: var(--text-dim); }
.compare-empty .icon { font-size: 40px; margin-bottom: 12px; }
.compare-grid { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 12px; }
.compare-card {
  flex: 1 0 200px; max-width: 280px; background: var(--surface);
  border: 1px solid var(--border); border-radius: 12px; padding: 16px;
}
.compare-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
.compare-remove {
  background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3);
  color: var(--red-text); border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 11px;
}
.compare-name { font-size: 14px; font-weight: 600; margin-bottom: 4px; line-height: 1.3; }
.compare-meta { font-size: 12px; color: var(--text-muted); margin-bottom: 12px; }
.compare-price { font-size: 28px; font-weight: 700; font-family: var(--mono); margin-bottom: 4px; }
.compare-field { margin-bottom: 8px; }
.compare-field-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; }
.compare-field-value { font-size: 13px; }
/* Pharmacy directory */
.pharm-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px; }
.pharm-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; padding: 20px; border-left: 3px solid var(--accent);
}
.pharm-card-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
.pharm-card-name { font-size: 16px; font-weight: 700; }
.pharm-card-addr { font-size: 12px; color: var(--text-dim); margin-top: 2px; }
.pharm-count {
  padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;
}
.pharm-field { margin-bottom: 8px; }
.pharm-field-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; }
.pharm-field-value { font-size: 13px; }
/* Missing info */
.missing-banner {
  background: rgba(251,191,36,0.08); border: 1px solid rgba(251,191,36,0.2);
  border-radius: 10px; padding: 16px; margin-bottom: 20px;
}
.missing-title { font-size: 14px; font-weight: 600; color: var(--yellow); margin-bottom: 4px; }
.missing-desc { font-size: 13px; color: var(--text-muted); }
.missing-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; padding: 16px; margin-bottom: 12px;
}
.missing-card h3 { font-size: 15px; font-weight: 600; margin-bottom: 10px; }
.missing-item { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
.missing-checkbox {
  width: 18px; height: 18px; border-radius: 4px; flex-shrink: 0;
  border: 1.5px solid rgba(99,102,241,0.4); display: flex;
  align-items: center; justify-content: center; font-size: 10px; color: var(--text-dim);
}
.missing-item span { font-size: 13px; }
/* Loading */
.loading { text-align: center; padding: 80px; }
.loading-spinner {
  width: 40px; height: 40px; border: 3px solid var(--border);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin 0.8s linear infinite; margin: 0 auto 16px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { color: var(--text-muted); font-size: 14px; }
.error-banner {
  background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2);
  border-radius: 10px; padding: 16px; margin-bottom: 20px;
}
.error-title { font-size: 14px; font-weight: 600; color: var(--red-text); margin-bottom: 4px; }
.error-desc { font-size: 13px; color: var(--text-muted); }
.demo-banner {
  background: rgba(99,102,241,0.08); border: 1px solid rgba(99,102,241,0.2);
  border-radius: 10px; padding: 16px; margin-bottom: 20px;
}
.demo-title { font-size: 14px; font-weight: 600; color: var(--accent-light); margin-bottom: 4px; }
.demo-desc { font-size: 13px; color: var(--text-muted); }
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <div class="header-top">
      <div class="logo">
        <div class="logo-icon">M</div>
        <div>
          <h1>Medstation Pharmacy Catalog</h1>
          <p id="subtitle">Loading...</p>
        </div>
      </div>
      <div>
        <div class="toggle-group">
          <button class="toggle-btn active" id="btn-admin" onclick="setView('admin')">Admin</button>
          <button class="toggle-btn" id="btn-staff" onclick="setView('staff')">Staff</button>
        </div>
      </div>
    </div>
    <div class="tabs">
      <button class="tab-btn active" id="tab-catalog" onclick="setTab('catalog')">Product Catalog</button>
      <button class="tab-btn" id="tab-compare" onclick="setTab('compare')">Compare <span id="compare-count"></span></button>
      <button class="tab-btn" id="tab-pharmacies" onclick="setTab('pharmacies')">Pharmacy Directory</button>
      <button class="tab-btn" id="tab-missing" onclick="setTab('missing')">Missing Info</button>
    </div>
  </div>
</div>

<div class="content" id="app-content">
  <div class="loading" id="loading-screen">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading pharmacy catalog...</div>
  </div>
</div>

<script>
// ═══ APP STATE ═══
const APP = {
  view: 'admin',
  tab: 'catalog',
  search: '',
  state: '',
  catalog: 'All',
  category: 'All',
  sortBy: 'price-asc',
  includeShipping: true,
  compareMode: false,
  compareItems: [],
  expandedId: null,
  // Data
  products: [],
  stateCoverage: {},
  pharmacyDir: [],
  loaded: false,
  demoMode: false,
};

// ═══ PHARMACY COLORS ═══
const PHARM_COLORS = {
  'RXCS':       { bg: '#1a2744', text: '#7eb8ff', accent: '#3b82f6' },
  'Absolute':   { bg: '#1a3328', text: '#6ee7b7', accent: '#10b981' },
  'Epiq':       { bg: '#2d1a3d', text: '#c4b5fd', accent: '#8b5cf6' },
  'Rush':       { bg: '#3d2a1a', text: '#fbbf24', accent: '#f59e0b' },
  'Hallandale': { bg: '#1a2d3d', text: '#67e8f9', accent: '#06b6d4' },
  'Texas Star': { bg: '#3d1a1a', text: '#fca5a5', accent: '#ef4444' },
  'Brooksville':{ bg: '#2a2a1a', text: '#d4d4aa', accent: '#a3a33a' },
  'Olympia':    { bg: '#1a2a2a', text: '#99d4d4', accent: '#4a9a9a' },
};

const PHARM_TO_MATRIX = {
  'RXCS': 'RXCS', 'Absolute': 'Absolute', 'Epiq': 'Epiq Scripts', 'Epiq Scripts': 'Epiq Scripts',
  'Rush': 'Rush', 'Hallandale': 'Hallandale', 'Texas Star': 'Texas Star',
  'Brooksville': null, 'Olympia': null,
};

// ═══ DATA FETCHING & PARSING ═══
function isConfigured() {
  return !Object.values(SHEET_URLS).some(u => u.includes('YOUR_CSV_URL'));
}

async function fetchCSV(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}: ${url}`);
  const text = await res.text();
  return Papa.parse(text, { header: false, skipEmptyLines: true }).data;
}

function findHeaderRow(rows, marker) {
  for (let i = 0; i < Math.min(rows.length, 15); i++) {
    if (rows[i][0] && rows[i][0].toString().trim() === marker) return i;
  }
  return -1;
}

function parseProductSheet(rows, catalogName) {
  const headerIdx = findHeaderRow(rows, '#');
  if (headerIdx < 0) return [];
  const headers = rows[headerIdx].map(h => (h || '').toString().trim());
  const products = [];

  for (let i = headerIdx + 1; i < rows.length; i++) {
    const row = rows[i];
    const num = (row[0] || '').toString().trim();
    if (!num || num.startsWith('▸') || isNaN(parseInt(num))) continue;

    const get = (name) => {
      const idx = headers.indexOf(name);
      return idx >= 0 ? (row[idx] || '').toString().trim() : '';
    };
    const getNum = (name) => {
      const v = get(name);
      const n = parseFloat(v);
      return isNaN(n) ? null : n;
    };

    // Handle different column naming conventions across sheets
    const cost = getNum('Pharmacy Cost') ?? getNum('Customer Price');
    const price = getNum('Suggested Price') ?? getNum('Patient Pay Price');
    const margin = getNum('Margin %');
    const notes = get('Notes') || get('Protocol/Notes');

    products.push({
      id: `${catalogName.substring(0,3).toUpperCase()}-${num}`,
      catalog: catalogName,
      category: get('Category'),
      productName: get('Product Name'),
      activeIngredient: get('Active Ingredient(s)'),
      strength: get('Strength'),
      form: get('Form'),
      qtySize: get('Vial/Qty') || get('Qty/Size') || get('Qty'),
      bud: get('BUD'),
      pharmacy: get('Pharmacy'),
      pharmacyCost: cost,
      suggestedPrice: price,
      margin: margin,
      formulaId: get('Formula ID'),
      stateCoverage: get('State Coverage'),
      notes: notes,
    });
  }
  return products;
}

function parseStateCoverage(rows) {
  const headerIdx = findHeaderRow(rows, 'State / Territory');
  if (headerIdx < 0) return {};
  const headers = rows[headerIdx].map(h => (h || '').toString().trim());
  const coverage = {};

  for (let i = headerIdx + 1; i < rows.length; i++) {
    const row = rows[i];
    const state = (row[0] || '').toString().trim();
    if (!state || state.toUpperCase().includes('TOTAL') || state.toUpperCase().includes('PHARMACY')) continue;
    coverage[state] = {};
    for (let j = 1; j < headers.length; j++) {
      if (headers[j] && headers[j] !== 'Total Available' && headers[j] !== 'Notes') {
        coverage[state][headers[j]] = (row[j] || '').toString().trim();
      }
    }
  }
  return coverage;
}

function parsePharmacyDir(rows) {
  const headerIdx = findHeaderRow(rows, 'Pharmacy');
  if (headerIdx < 0) return [];
  const headers = rows[headerIdx].map(h => (h || '').toString().trim());
  const dir = [];

  for (let i = headerIdx + 1; i < rows.length; i++) {
    const row = rows[i];
    const name = (row[0] || '').toString().trim();
    if (!name) continue;
    const get = (hdr) => {
      const idx = headers.indexOf(hdr);
      return idx >= 0 ? (row[idx] || '').toString().trim() : '';
    };
    // Derive short name for matching
    let shortName = name;
    if (name.includes('RXCS')) shortName = 'RXCS';
    else if (name.includes('Absolute')) shortName = 'Absolute';
    else if (name.includes('Epiq')) shortName = 'Epiq';
    else if (name.includes('Rush')) shortName = 'Rush';
    else if (name.includes('Hallandale')) shortName = 'Hallandale';
    else if (name.includes('Texas Star') || name.includes('Thesis')) shortName = 'Texas Star';
    else if (name.includes('Brooksville')) shortName = 'Brooksville';
    else if (name.includes('Olympia')) shortName = 'Olympia';

    dir.push({
      name: shortName,
      fullName: name,
      address: get('Address'),
      statesLicensed: get('States Licensed'),
      productTypes: get('Product Types'),
      specialty: get('Speciality') || get('Specialty'),
      contact: get('Contact'),
      legitScript: get('LegitScript'),
      shippingCost: get('Shipping Cost'),
      notes: get('Notes'),
    });
  }
  return dir;
}

async function loadData() {
  if (!isConfigured()) {
    APP.demoMode = true;
    APP.loaded = true;
    document.getElementById('subtitle').textContent = 'DEMO MODE — Configure Google Sheets URLs to load live data';
    render();
    return;
  }

  try {
    const [glp1, pep, test, other, states, dir] = await Promise.all([
      fetchCSV(SHEET_URLS.glp1),
      fetchCSV(SHEET_URLS.peptides),
      fetchCSV(SHEET_URLS.testhrt),
      fetchCSV(SHEET_URLS.other),
      fetchCSV(SHEET_URLS.states),
      fetchCSV(SHEET_URLS.directory),
    ]);

    APP.products = [
      ...parseProductSheet(glp1, 'GLP-1 Products'),
      ...parseProductSheet(pep, 'Peptides'),
      ...parseProductSheet(test, 'Testosterone & HRT'),
      ...parseProductSheet(other, 'Other Products'),
    ];
    APP.stateCoverage = parseStateCoverage(states);
    APP.pharmacyDir = parsePharmacyDir(dir);
    APP.loaded = true;
    APP.demoMode = false;

    const stateCount = Object.keys(APP.stateCoverage).length;
    const pharmCount = APP.pharmacyDir.length;
    document.getElementById('subtitle').textContent =
      `${APP.products.length} products · ${pharmCount} pharmacies · ${stateCount} states · Live from Google Sheets`;

    render();
  } catch (err) {
    console.error('Data load error:', err);
    APP.loaded = true;
    APP.loadError = err.message;
    render();
  }
}

// ═══ HELPERS ═══
function canShipToState(pharmacy, state) {
  if (!state) return true;
  const key = PHARM_TO_MATRIX[pharmacy];
  if (!key) return null;
  const sd = APP.stateCoverage[state];
  if (!sd) return null;
  const val = sd[key];
  return val === 'Yes' || val === 'Yes*';
}

function getPharmColors(pharmacy) {
  return PHARM_COLORS[pharmacy] || { bg: '#1a1a2e', text: '#94a3b8', accent: '#64748b' };
}

function getTotalPrice(product) {
  if (product.suggestedPrice == null) return 99999;
  return product.suggestedPrice + (APP.includeShipping ? (SHIPPING[product.pharmacy] || 0) : 0);
}

function formatPrice(p) { return p != null && p < 99999 ? '$' + Math.round(p) : 'TBD'; }
function formatMargin(m) { return m != null ? (m * 100).toFixed(1) + '%' : '—'; }
function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function getFilteredProducts() {
  const q = APP.search.toLowerCase();
  let results = APP.products.filter(p => {
    const matchSearch = !q ||
      p.productName.toLowerCase().includes(q) ||
      p.activeIngredient.toLowerCase().includes(q) ||
      p.category.toLowerCase().includes(q) ||
      p.pharmacy.toLowerCase().includes(q);
    const matchCatalog = APP.catalog === 'All' || p.catalog === APP.catalog;
    const matchCategory = APP.category === 'All' || p.category === APP.category;
    const matchState = !APP.state || canShipToState(p.pharmacy, APP.state) !== false;
    return matchSearch && matchCatalog && matchCategory && matchState;
  });

  results.sort((a, b) => {
    const pa = getTotalPrice(a), pb = getTotalPrice(b);
    if (APP.sortBy === 'price-asc') return pa - pb;
    if (APP.sortBy === 'price-desc') return pb - pa;
    if (APP.sortBy === 'margin-desc') return (b.margin || 0) - (a.margin || 0);
    if (APP.sortBy === 'name') return a.productName.localeCompare(b.productName);
    return 0;
  });
  return results;
}

function getBestPrices(filtered) {
  const groups = {};
  filtered.forEach(p => {
    const key = `${p.activeIngredient}|${p.strength}`;
    const tp = getTotalPrice(p);
    if (!groups[key] || tp < groups[key].price) groups[key] = { price: tp, count: 0 };
    groups[key].count++;
  });
  return groups;
}

function isBest(product, bestPrices) {
  const key = `${product.activeIngredient}|${product.strength}`;
  const bp = bestPrices[key];
  return bp && bp.count > 1 && getTotalPrice(product) === bp.price;
}

// ═══ VIEW/TAB CONTROLS ═══
function setView(v) {
  APP.view = v;
  document.getElementById('btn-admin').className = 'toggle-btn' + (v === 'admin' ? ' active' : '');
  document.getElementById('btn-staff').className = 'toggle-btn' + (v === 'staff' ? ' active' : '');
  render();
}

function setTab(t) {
  APP.tab = t;
  document.querySelectorAll('.tab-btn').forEach(b => b.className = 'toggle-btn tab-btn' + (b.id === 'tab-' + t ? ' active' : ''));
  document.getElementById('tab-' + t).className = 'tab-btn active';
  render();
}

function updateCompareCount() {
  const el = document.getElementById('compare-count');
  el.textContent = APP.compareItems.length > 0 ? `(${APP.compareItems.length})` : '';
}

function toggleCompare(productId) {
  const idx = APP.compareItems.findIndex(p => p.id === productId);
  if (idx >= 0) {
    APP.compareItems.splice(idx, 1);
  } else if (APP.compareItems.length < 6) {
    const product = APP.products.find(p => p.id === productId);
    if (product) APP.compareItems.push(product);
  }
  updateCompareCount();
  render();
}

function toggleExpand(productId) {
  APP.expandedId = APP.expandedId === productId ? null : productId;
  render();
}

// ═══ RENDER ═══
function render() {
  const el = document.getElementById('app-content');

  if (!APP.loaded) return;

  if (APP.loadError) {
    el.innerHTML = `
      <div class="error-banner">
        <div class="error-title">Failed to Load Data</div>
        <div class="error-desc">Could not fetch data from Google Sheets. Check that the CSV URLs are correct and the sheet is published.<br><br>Error: ${escapeHtml(APP.loadError)}</div>
      </div>`;
    return;
  }

  if (APP.demoMode) {
    el.innerHTML = `
      <div class="demo-banner">
        <div class="demo-title">Demo Mode — No Live Data Connected</div>
        <div class="demo-desc">
          The Google Sheets CSV URLs haven't been configured yet. To connect live data:<br>
          1. Upload <strong>Medstation_Catalog_Template.xlsx</strong> to Google Sheets<br>
          2. Go to <strong>File → Share → Publish to Web</strong><br>
          3. Publish each tab as CSV and copy the URLs<br>
          4. Open this HTML file, paste the URLs in the <code>SHEET_URLS</code> config at the top<br>
          5. Push to GitHub and enable GitHub Pages<br><br>
          See the <strong>APP CONFIG</strong> tab in the Google Sheet for detailed instructions.
        </div>
      </div>`;
    return;
  }

  if (APP.tab === 'catalog') renderCatalog(el);
  else if (APP.tab === 'compare') renderCompare(el);
  else if (APP.tab === 'pharmacies') renderPharmacies(el);
  else if (APP.tab === 'missing') renderMissing(el);
}

function renderCatalog(el) {
  const catalogs = ['All', ...new Set(APP.products.map(p => p.catalog))];
  const catsForCatalog = APP.products
    .filter(p => APP.catalog === 'All' || p.catalog === APP.catalog)
    .map(p => p.category);
  const categories = ['All', ...new Set(catsForCatalog)];
  const states = Object.keys(APP.stateCoverage).sort();

  const filtered = getFilteredProducts();
  const bestPrices = getBestPrices(filtered);

  let html = `
    <div class="filters">
      <input class="filter-input" type="text" placeholder="Search drug name, ingredient, category, pharmacy..."
        value="${escapeHtml(APP.search)}" oninput="APP.search=this.value;render()">
      <select class="filter-select" onchange="APP.state=this.value;render()">
        <option value="">All States</option>
        ${states.map(s => `<option value="${s}"${APP.state === s ? ' selected' : ''}>${s}</option>`).join('')}
      </select>
      <select class="filter-select" onchange="APP.catalog=this.value;APP.category='All';render()">
        ${catalogs.map(c => `<option value="${c}"${APP.catalog === c ? ' selected' : ''}>${c}</option>`).join('')}
      </select>
      <select class="filter-select" onchange="APP.category=this.value;render()">
        ${categories.map(c => `<option value="${c}"${APP.category === c ? ' selected' : ''}>${c}</option>`).join('')}
      </select>
    </div>
    <div class="controls">
      <div class="controls-left">
        <span class="result-count">${filtered.length} results</span>
        <label class="control-label">
          <input type="checkbox" ${APP.includeShipping ? 'checked' : ''} onchange="APP.includeShipping=this.checked;render()">
          Include shipping
        </label>
        <label class="control-label">
          <input type="checkbox" ${APP.compareMode ? 'checked' : ''} onchange="APP.compareMode=this.checked;render()">
          Compare mode
        </label>
      </div>
      <select class="sort-select" onchange="APP.sortBy=this.value;render()">
        <option value="price-asc"${APP.sortBy==='price-asc'?' selected':''}>Price: Low → High</option>
        <option value="price-desc"${APP.sortBy==='price-desc'?' selected':''}>Price: High → Low</option>
        ${APP.view === 'admin' ? `<option value="margin-desc"${APP.sortBy==='margin-desc'?' selected':''}>Margin: High → Low</option>` : ''}
        <option value="name"${APP.sortBy==='name'?' selected':''}>Name A-Z</option>
      </select>
    </div>`;

  if (filtered.length === 0) {
    html += `<div style="text-align:center;padding:40px;color:var(--text-dim);">No products match your filters. Try broadening your search.</div>`;
  } else {
    filtered.forEach(p => {
      const pc = getPharmColors(p.pharmacy);
      const total = getTotalPrice(p);
      const best = isBest(p, bestPrices);
      const inCompare = APP.compareItems.some(c => c.id === p.id);
      const shipStatus = APP.state ? canShipToState(p.pharmacy, APP.state) : null;
      const expanded = APP.expandedId === p.id;
      const shipping = SHIPPING[p.pharmacy] || 0;

      html += `<div class="product-row${best ? ' best' : ''}${inCompare ? ' in-compare' : ''}" onclick="toggleExpand('${p.id}')">
        <div class="row-main">
          ${APP.compareMode ? `<input type="checkbox" ${inCompare ? 'checked' : ''} onclick="event.stopPropagation();toggleCompare('${p.id}')" style="accent-color:var(--accent);width:16px;height:16px;flex-shrink:0">` : ''}
          ${best ? '<span class="badge-best">BEST PRICE</span>' : ''}
          <span class="pharm-pill" style="background:${pc.bg};color:${pc.text};border:1px solid ${pc.accent}33">${escapeHtml(p.pharmacy)}</span>
          <span class="product-name">${escapeHtml(p.productName)}</span>
          <span class="product-meta">${escapeHtml(p.category)}</span>
          <span class="product-meta">${escapeHtml(p.form)}${p.qtySize && p.qtySize !== '—' ? ' · ' + escapeHtml(p.qtySize) : ''}</span>
          ${APP.state && shipStatus !== null ? `<span class="state-badge ${shipStatus === true ? 'yes' : shipStatus === false ? 'no' : 'unknown'}">${shipStatus === true ? '✓' : shipStatus === false ? '✗' : '?'}</span>` : ''}
          <div class="price-area">
            <div class="price-main${best ? ' best-price' : ''}">${formatPrice(total < 99999 ? total : null)}</div>
            ${APP.includeShipping && shipping > 0 && p.suggestedPrice != null ? `<div class="price-detail">${formatPrice(p.suggestedPrice)} + $${shipping} ship${SHIPPING_ESTIMATED[p.pharmacy] ? '<span class="price-est"> ~est</span>' : ''}</div>` : ''}
          </div>
          ${APP.view === 'admin' ? `
            <div class="margin-area">
              <div class="margin-val ${p.margin > 0.6 ? 'high' : p.margin > 0.5 ? 'mid' : 'low'}">${formatMargin(p.margin)}</div>
              ${p.pharmacyCost != null ? `<div class="margin-cost">cost: $${p.pharmacyCost}</div>` : ''}
            </div>` : ''}
        </div>
        ${expanded ? `
          <div class="product-details">
            <div>
              <div class="detail-label">Active Ingredient</div>
              <div class="detail-value">${escapeHtml(p.activeIngredient)}</div>
              <div class="detail-label">Strength</div>
              <div class="detail-value">${escapeHtml(p.strength)}</div>
              ${p.formulaId ? `<div class="detail-label">Formula ID</div><div class="detail-value">${escapeHtml(p.formulaId)}</div>` : ''}
            </div>
            <div>
              <div class="detail-label">State Coverage</div>
              <div class="detail-value">${escapeHtml(p.stateCoverage)}</div>
              ${p.notes ? `<div class="detail-label">Notes</div><div class="detail-value">${escapeHtml(p.notes)}</div>` : ''}
            </div>
            <div>
              ${APP.view === 'admin' ? `
                <div class="detail-label">Pharmacy Cost</div>
                <div class="detail-value" style="font-family:var(--mono)">${p.pharmacyCost != null ? '$' + p.pharmacyCost : 'TBD'}</div>
                <div class="detail-label">Margin</div>
                <div class="detail-value" style="font-family:var(--mono)">${formatMargin(p.margin)}</div>` : ''}
              <div class="detail-label">Patient Price</div>
              <div class="detail-value" style="font-family:var(--mono)">${formatPrice(p.suggestedPrice)}</div>
            </div>
          </div>` : ''}
      </div>`;
    });
  }
  el.innerHTML = html;
}

function renderCompare(el) {
  if (APP.compareItems.length === 0) {
    el.innerHTML = `<div class="compare-empty"><div class="icon">⚖️</div><div style="font-size:16px;font-weight:600;margin-bottom:8px">No products selected</div><div>Enable "Compare mode" in the Catalog tab and select up to 6 products.</div></div>`;
    return;
  }

  let html = '<div class="compare-grid">';
  APP.compareItems.forEach(p => {
    const pc = getPharmColors(p.pharmacy);
    const total = getTotalPrice(p);
    const shipping = SHIPPING[p.pharmacy] || 0;

    const fields = [
      ['Active Ingredient', p.activeIngredient],
      ['Strength', p.strength],
      ['Qty/Size', p.qtySize],
      ['State Coverage', p.stateCoverage],
    ];
    if (APP.view === 'admin') {
      fields.push(['Pharmacy Cost', p.pharmacyCost != null ? '$' + p.pharmacyCost : 'TBD']);
      fields.push(['Margin', formatMargin(p.margin)]);
    }
    if (p.notes) fields.push(['Notes', p.notes]);

    html += `<div class="compare-card">
      <div class="compare-header">
        <span class="pharm-pill" style="background:${pc.bg};color:${pc.text};border:1px solid ${pc.accent}33">${escapeHtml(p.pharmacy)}</span>
        <button class="compare-remove" onclick="toggleCompare('${p.id}')">✕</button>
      </div>
      <div class="compare-name">${escapeHtml(p.productName)}</div>
      <div class="compare-meta">${escapeHtml(p.category)} · ${escapeHtml(p.form)}</div>
      <div class="compare-price">${formatPrice(total < 99999 ? total : null)}</div>
      ${APP.includeShipping && shipping > 0 && p.suggestedPrice != null ? `<div style="font-size:11px;color:var(--text-dim);margin-bottom:12px">${formatPrice(p.suggestedPrice)} + $${shipping} shipping</div>` : '<div style="margin-bottom:12px"></div>'}
      ${fields.map(([l, v]) => `<div class="compare-field"><div class="compare-field-label">${l}</div><div class="compare-field-value">${escapeHtml(v || '—')}</div></div>`).join('')}
    </div>`;
  });
  html += '</div>';
  el.innerHTML = html;
}

function renderPharmacies(el) {
  const dirs = APP.pharmacyDir.length > 0 ? APP.pharmacyDir : Object.keys(PHARM_COLORS).map(name => ({
    name, fullName: name, address: '—', statesLicensed: '—', specialty: '—', contact: '—', shippingCost: '$' + (SHIPPING[name] || 0), notes: ''
  }));

  let html = '<div class="pharm-grid">';
  dirs.forEach(ph => {
    const pc = getPharmColors(ph.name);
    const count = APP.products.filter(p => p.pharmacy === ph.name).length;
    const shipping = ph.shippingCost || ('$' + (SHIPPING[ph.name] || 0));

    const fields = [
      ['States Licensed', ph.statesLicensed],
      ['Specialty', ph.specialty],
      ['Shipping', shipping + (SHIPPING_ESTIMATED[ph.name] ? ' (estimated — confirm with pharmacy)' : '')],
    ];
    if (ph.contact && ph.contact !== '—') fields.push(['Contact', ph.contact]);
    if (ph.notes) fields.push(['Notes', ph.notes]);

    html += `<div class="pharm-card" style="border-left-color:${pc.accent}">
      <div class="pharm-card-header">
        <div>
          <div class="pharm-card-name" style="color:${pc.text}">${escapeHtml(ph.fullName)}</div>
          <div class="pharm-card-addr">${escapeHtml(ph.address)}</div>
        </div>
        <span class="pharm-count" style="background:${pc.bg};color:${pc.text};border:1px solid ${pc.accent}33">${count} products</span>
      </div>
      ${fields.map(([l, v]) => `<div class="pharm-field"><div class="pharm-field-label">${l}</div><div class="pharm-field-value">${escapeHtml(v || '—')}</div></div>`).join('')}
    </div>`;
  });
  html += '</div>';
  el.innerHTML = html;
}

function renderMissing(el) {
  const missingInfo = [
    { pharmacy: 'Absolute Pharmacy', items: ['Standard shipping cost per order', 'Expedited shipping options and pricing', 'Minimum order for free shipping (if any)', 'Current processing time (order → ship)'] },
    { pharmacy: 'Epiq Scripts', items: ['Standard shipping cost per order', 'Expedited shipping options and pricing', 'Minimum order for free shipping (if any)', 'Current processing time (order → ship)'] },
    { pharmacy: 'Rush Pharmacy', items: ['Standard shipping cost per order', 'Expedited shipping options and pricing', 'Minimum order for free shipping (if any)', 'Current processing time (order → ship)'] },
    { pharmacy: 'Brooksville Pharmacy', items: ['Confirmed state licensing list', 'Exact shipping by product category ($13-33 range)', 'Pharmacy cost: Tesamorelin, SS-31, Nandrolone, Oxandrolone, Oxymetholone', 'LegitScript certification status'] },
    { pharmacy: 'Olympia Pharmacy', items: ['Full state licensing list', 'Pharmacy cost: NAD+ 200mg/mL 10mL', 'Complete product catalog availability', 'LegitScript certification status'] },
    { pharmacy: 'Texas Star / Thesis', items: ['Full multi-state licensing list (beyond TX+OK)', 'Pharmacy cost: Sema/NAD+ and Tirz/NAD+/L-Carnitine products', 'Shipping cost for non-DFW metro areas', 'Updated product catalog under Thesis rebrand'] },
    { pharmacy: 'Hallandale Pharmacy', items: ['Illinois license reinstatement status', 'LegitScript certification timeline', 'Updated Flex-Dose tirzepatide pricing'] },
  ];

  let html = `
    <div class="missing-banner">
      <div class="missing-title">Action Required: Pharmacy Data Collection</div>
      <div class="missing-desc">The following information is needed from each pharmacy partner. Pharmacy staff should email each partner using contact info in the Pharmacy Directory tab.</div>
    </div>`;

  missingInfo.forEach(mi => {
    html += `<div class="missing-card">
      <h3>${escapeHtml(mi.pharmacy)}</h3>
      ${mi.items.map(item => `<div class="missing-item"><div class="missing-checkbox">☐</div><span>${escapeHtml(item)}</span></div>`).join('')}
    </div>`;
  });
  el.innerHTML = html;
}

// ═══ INIT ═══
loadData();
</script>
</body>
</html>
